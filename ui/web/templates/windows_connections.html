<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„Windowsç½‘ç»œå®æ—¶è¿æ¥ç›‘æ§ - è¿æ¥ç›‘æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .nav {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .nav a {
            padding: 15px 20px;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .nav a:hover {
            background-color: #3498db;
            color: white;
        }
        
        .nav a.active {
            background-color: #3498db;
            color: white;
        }
        

        
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            height: 400px;
        }
        
        .connections-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .connections-table th,
        .connections-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        /* è¿›ç¨‹ååˆ—å›ºå®šå®½åº¦å’Œæ»šåŠ¨æ ·å¼ */
        .connections-table th:nth-child(5),
        .connections-table td:nth-child(5) {
            width: 120px;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        
        .connections-table td:nth-child(5):hover {
            overflow: visible;
            z-index: 10;
            background-color: white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            white-space: normal;
            word-wrap: break-word;
            max-width: none;
        }
        
        .connections-table th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 30px;
        }
        
        .connections-table th:hover {
            background-color: #2980b9;
        }
        
        .connections-table th.sort-asc::after {
            content: 'â–²';
            position: absolute;
            right: 10px;
            font-size: 12px;
        }
        
        .connections-table th.sort-desc::after {
            content: 'â–¼';
            position: absolute;
            right: 10px;
            font-size: 12px;
        }
        
        .connections-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .connections-table tr:last-child td {
            border-bottom: none;
        }
        
        .protocol-tcp {
            color: #3498db;
            font-weight: bold;
        }
        
        .protocol-udp {
            color: #9b59b6;
            font-weight: bold;
        }
        
        .status-established {
            color: #27ae60;
            font-weight: bold;
        }
        
        .foreign-location {
            color: #e74c3c !important;
            font-weight: bold;
        }
        
        /* å›½å†…IPåœ°ç†ä½ç½®æ ·å¼ */
        .domestic-location {
            color: #3498db;
            font-weight: bold;
        }
        
        .status-listening {
            color: #f39c12;
            font-weight: bold;
        }
        
        .status-time_wait {
            color: #95a5a6;
            font-weight: bold;
        }
        
        .location-local {
            color: #3498db;
            font-weight: bold;
        }
        
        /* åœ°ç†ä½ç½®æŸ¥è¯¢æŒ‰é’®æ ·å¼ */
        .btn-lookup {
            background: #3498db;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            color: white;
            cursor: pointer;
            margin-left: 5px;
            vertical-align: middle;
            transition: all 0.3s ease;
        }
        
        .btn-lookup:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        .btn-lookup:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-lookup.loading {
            background: #f39c12;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .location-info {
            display: inline-block;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .location-info.updated {
            color: #27ae60;
            font-weight: bold;
            animation: highlight 1s ease;
        }
        
        @keyframes highlight {
            0% { background-color: #d5f4e6; }
            100% { background-color: transparent; }
        }
        
        .search-box {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .search-box input {
            padding: 10px;
            width: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        

        
        .interface-info {
            margin-left: 10px;
            flex-grow: 1;
        }
        
        .interface-name {
            font-weight: bold;
        }
        
        .interface-details {
            font-size: 12px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æˆ‘çš„Windowsç½‘ç»œå®æ—¶è¿æ¥ç›‘æ§ - è¿æ¥ç›‘æ§</h1>
        
        <div class="nav">
            <a href="/dashboard">ä»ªè¡¨ç›˜</a>
            <a href="/connections" class="active">è¿æ¥ç›‘æ§</a>
            <a href="/processes">è¿›ç¨‹ç›‘æ§</a>
            <a href="/protocols">åè®®åˆ†æ</a>
            <a href="/earth">åœ°çƒè§†å›¾</a>
        </div>
        

        
        <!-- æœç´¢æ¡† -->
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢IPåœ°å€ã€è¿›ç¨‹åæˆ–ç«¯å£å·...">
            <button id="exportCsvBtn" style="margin-left: 10px; padding: 10px 15px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                å¯¼å‡ºCSV
            </button>
        </div>
        
        <div class="chart-container" id="connectionsChart"></div>
        
        <table class="connections-table">
            <thead>
                <tr>
                    <th>åè®®</th>
                    <th>æœ¬åœ°åœ°å€</th>
                    <th>è¿œç¨‹åœ°å€</th>
                    <th>åœ°ç†ä½ç½®</th>
                    <th>è¿›ç¨‹å</th>
                    <th>å‘é€å­—èŠ‚</th>
                    <th>æ¥æ”¶å­—èŠ‚</th>
                    <th>æ€»æµé‡</th>
                    <th>çŠ¶æ€</th>
                    <th>æ—¶é•¿</th>
                </tr>
            </thead>
            <tbody id="connectionsBody">
                <tr>
                    <td colspan="10" style="text-align: center; color: #666; font-style: italic;">åŠ è½½ä¸­......</td>
                </tr>
            </tbody>
        </table>
    </div>
    


    <script>
        // åˆå§‹åŒ–EChartså›¾è¡¨
        const connectionsChart = echarts.init(document.getElementById('connectionsChart'));
        
        // å›¾è¡¨é€‰é¡¹
        const connectionsOption = {
            title: {
                text: 'æ´»åŠ¨è¿æ¥è¶‹åŠ¿',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['æ´»åŠ¨è¿æ¥æ•°'],
                top: 30
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                top: 60,
                containLabel: true
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: []
            },
            yAxis: {
                type: 'value',
                name: 'è¿æ¥æ•°'
            },
            series: [
                {
                    name: 'æ´»åŠ¨è¿æ¥æ•°',
                    type: 'line',
                    smooth: true,
                    data: [],
                    itemStyle: {
                        color: '#f39c12'
                    }
                }
            ]
        };
        
        // è®¾ç½®å›¾è¡¨é€‰é¡¹
        connectionsChart.setOption(connectionsOption);
        
        // æ•°æ®æ•°ç»„
        let timeData = [];
        let connectionsData = [];
        
        // é¡µé¢ç‰¹å®šçš„æ•°æ®æ›´æ–°å‡½æ•°
        window.updatePageData = function() {
            // è·å–è¿æ¥æ•°æ®ï¼ˆä¸ä¾èµ–ç›‘æ§çŠ¶æ€ï¼‰
            fetch('/api/sessions')
                .then(response => {
                    if (!response.ok) {
                        console.error(`Sessions API error: ${response.status}`);
                        return []; // è¿”å›ç©ºæ•°ç»„è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
                    }
                    return response.json();
                })
                .then(connections => {
                    const tbody = document.getElementById('connectionsBody');
                    
                    // ç¡®ä¿connectionsæ˜¯æ•°ç»„
                    if (!Array.isArray(connections)) {
                        connections = [];
                    }
                    
                    console.log(`è·å–åˆ° ${connections.length} æ¡è¿æ¥æ•°æ®`);
                    
                    if (connections.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">æš‚æ— ç½‘ç»œè¿æ¥æ•°æ®</td></tr>';
                    } else {
                        // æ ¼å¼åŒ–å­—èŠ‚å¤§å°
                        function formatBytes(bytes) {
                            if (bytes === 0) return '0 B';
                            const k = 1024;
                            const sizes = ['B', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                        }
                        
                        // æ ¼å¼åŒ–æ—¶é•¿
                        function formatDuration(seconds) {
                            if (seconds < 60) return seconds + 'ç§’';
                            if (seconds < 3600) return Math.floor(seconds / 60) + 'åˆ†';
                            return Math.floor(seconds / 3600) + 'æ—¶' + Math.floor((seconds % 3600) / 60) + 'åˆ†';
                        }
                        
                        // è¿‡æ»¤æ‰ç›®çš„åœ°å€ä¸ºç§æœ‰ç½‘æ®µå’Œæœ¬åœ°åœ°å€çš„è¿æ¥
                        const filteredConnections = connections.filter(conn => {
                            // åªè¿‡æ»¤ç›®çš„åœ°å€ä¸ºç§æœ‰ç½‘æ®µæˆ–æœ¬åœ°åœ°å€çš„è¿æ¥
                            if (!conn.dst_ip) return true; // ä¿ç•™æ²¡æœ‰ç›®çš„åœ°å€çš„è¿æ¥
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°åœ°å€
                            const isLocalAddress = 
                                conn.dst_ip === '127.0.0.1' ||
                                conn.dst_ip === 'localhost' ||
                                conn.dst_ip.startsWith('127.');
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯ç§æœ‰ç½‘æ®µçš„ç›®çš„åœ°å€
                            const isPrivateDestination = 
                                conn.dst_ip.startsWith('192.168.') ||
                                conn.dst_ip.startsWith('10.') ||
                                (conn.dst_ip.startsWith('172.') && 
                                 parseInt(conn.dst_ip.split('.')[1]) >= 16 && 
                                 parseInt(conn.dst_ip.split('.')[1]) <= 31);
                            
                            // ä¿ç•™æ‰€æœ‰éç§æœ‰ç½‘æ®µä¸”éæœ¬åœ°åœ°å€çš„ç›®çš„åœ°å€è¿æ¥
                            return !isLocalAddress && !isPrivateDestination;
                        });
                        
                        console.log(`è¿‡æ»¤åæ˜¾ç¤º ${filteredConnections.length} æ¡å¤–éƒ¨è¿æ¥`);
                        
                        // æ›´æ–°è¿æ¥è¡¨æ ¼
                        tbody.innerHTML = filteredConnections.map(conn => `
                            <tr>
                                <td class="protocol-${conn.protocol.toLowerCase()}">${conn.protocol}</td>
                                <td>${conn.src_ip}:${conn.src_port}</td>
                                <td>${conn.dst_ip}:${conn.dst_port}</td>
                                <td class="${conn.location && (conn.location.includes('ä¸­å›½') && !conn.location.includes('æœªçŸ¥')) ? 'domestic-location' : (conn.location && !conn.location.includes('æœ¬åœ°') && !conn.location.includes('æœªçŸ¥') ? 'foreign-location' : '')}">${conn.location || 'æœªçŸ¥'}</td>
                                <td>${conn.process_name && conn.process_name.toLowerCase() !== 'unknown' ? conn.process_name : (conn.pid ? 'PID:' + conn.pid : 'æœªçŸ¥')}</td>
                                <td>${formatBytes(conn.bytes_sent)}</td>
                                <td>${formatBytes(conn.bytes_received)}</td>
                                <td><strong>${formatBytes(conn.total_bytes)}</strong></td>
                                <td><span class="status-${conn.state.toLowerCase()}">${conn.state}</span></td>
                                <td>${formatDuration(conn.duration)}</td>
                            </tr>
                        `).join('');
                        
                        // æ›´æ–°è¿æ¥å›¾è¡¨
                        const now = new Date();
                        const timeStr = now.toLocaleTimeString();
                        
                        timeData.push(timeStr);
                        connectionsData.push(filteredConnections.length);
                        
                        // ä¿æŒæœ€è¿‘20ä¸ªæ•°æ®ç‚¹
                        if (timeData.length > 20) {
                            timeData.shift();
                            connectionsData.shift();
                        }
                        
                        connectionsChart.setOption({
                            xAxis: { data: timeData },
                            series: [{ data: connectionsData }]
                        });
                    }
                })
                .catch(error => {
                    console.error('Connections API error:', error);
                    const tbody = document.getElementById('connectionsBody');
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</td></tr>';
                });
        };
        
        // æ›´æ–°é¡µé¢æ•°æ®çš„å‡½æ•°
        function updatePageData() {
            // è·å–è¿æ¥æ•°æ®
            fetch('/api/sessions')
                .then(response => {
                    if (!response.ok) {
                        console.error(`Sessions API error: ${response.status}`);
                        return []; // è¿”å›ç©ºæ•°ç»„è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
                    }
                    return response.json();
                })
                .then(connections => {
                    const tbody = document.getElementById('connectionsBody');
                    
                    // ç¡®ä¿connectionsæ˜¯æ•°ç»„
                    if (!Array.isArray(connections)) {
                        connections = [];
                    }
                    
                    console.log(`è·å–åˆ° ${connections.length} æ¡è¿æ¥æ•°æ®`);
                    
                    if (connections.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">æš‚æ— ç½‘ç»œè¿æ¥æ•°æ®</td></tr>';
                    } else {
                        // æ ¼å¼åŒ–å­—èŠ‚å¤§å°
                        function formatBytes(bytes) {
                            if (bytes === 0) return '0 B';
                            const k = 1024;
                            const sizes = ['B', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                        }
                        
                        // æ ¼å¼åŒ–æ—¶é•¿
                        function formatDuration(seconds) {
                            if (seconds < 60) return seconds + 'ç§’';
                            if (seconds < 3600) return Math.floor(seconds / 60) + 'åˆ†';
                            return Math.floor(seconds / 3600) + 'æ—¶' + Math.floor((seconds % 3600) / 60) + 'åˆ†';
                        }
                        
                        // è¿‡æ»¤æ‰ç›®çš„åœ°å€ä¸ºç§æœ‰ç½‘æ®µå’Œæœ¬åœ°åœ°å€çš„è¿æ¥
                        const filteredConnections = connections.filter(conn => {
                            // åªè¿‡æ»¤ç›®çš„åœ°å€ä¸ºç§æœ‰ç½‘æ®µæˆ–æœ¬åœ°åœ°å€çš„è¿æ¥
                            if (!conn.dst_ip) return true; // ä¿ç•™æ²¡æœ‰ç›®çš„åœ°å€çš„è¿æ¥
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°åœ°å€
                            const isLocalAddress = 
                                conn.dst_ip === '127.0.0.1' ||
                                conn.dst_ip === 'localhost' ||
                                conn.dst_ip.startsWith('127.');
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯ç§æœ‰ç½‘æ®µçš„ç›®çš„åœ°å€
                            const isPrivateDestination = 
                                conn.dst_ip.startsWith('192.168.') ||
                                conn.dst_ip.startsWith('10.') ||
                                (conn.dst_ip.startsWith('172.') && 
                                 parseInt(conn.dst_ip.split('.')[1]) >= 16 && 
                                 parseInt(conn.dst_ip.split('.')[1]) <= 31);
                            
                            // ä¿ç•™æ‰€æœ‰éç§æœ‰ç½‘æ®µä¸”éæœ¬åœ°åœ°å€çš„ç›®çš„åœ°å€è¿æ¥
                            return !isLocalAddress && !isPrivateDestination;
                        });
                        
                        console.log(`è¿‡æ»¤åæ˜¾ç¤º ${filteredConnections.length} æ¡å¤–éƒ¨è¿æ¥`);
                        
                        // æ›´æ–°è¿æ¥è¡¨æ ¼
                        tbody.innerHTML = filteredConnections.map(conn => `
                            <tr>
                                <td class="protocol-${conn.protocol.toLowerCase()}">${conn.protocol}</td>
                                <td>${conn.src_ip}:${conn.src_port}</td>
                                <td>${conn.dst_ip}:${conn.dst_port}</td>
                                <td class="${conn.location && (conn.location.includes('ä¸­å›½') && !conn.location.includes('æœªçŸ¥')) ? 'domestic-location' : (conn.location && !conn.location.includes('æœ¬åœ°') && !conn.location.includes('æœªçŸ¥') ? 'foreign-location' : '')}">${conn.location || 'æœªçŸ¥'}</td>
                                <td>${conn.process_name && conn.process_name.toLowerCase() !== 'unknown' ? conn.process_name : (conn.pid ? 'PID:' + conn.pid : 'æœªçŸ¥')}</td>
                                <td>${formatBytes(conn.bytes_sent)}</td>
                                <td>${formatBytes(conn.bytes_received)}</td>
                                <td><strong>${formatBytes(conn.total_bytes)}</strong></td>
                                <td><span class="status-${conn.state.toLowerCase()}">${conn.state}</span></td>
                                <td>${formatDuration(conn.duration)}</td>
                            </tr>
                        `).join('');
                        
                        // æ›´æ–°è¿æ¥å›¾è¡¨
                        const now = new Date();
                        const timeStr = now.toLocaleTimeString();
                        
                        timeData.push(timeStr);
                        connectionsData.push(filteredConnections.length);
                        
                        // ä¿æŒæœ€è¿‘20ä¸ªæ•°æ®ç‚¹
                        if (timeData.length > 20) {
                            timeData.shift();
                            connectionsData.shift();
                        }
                        
                        connectionsChart.setOption({
                            xAxis: { data: timeData },
                            series: [{ data: connectionsData }]
                        });
                    }
                })
                .catch(error => {
                    console.error('Connections API error:', error);
                    const tbody = document.getElementById('connectionsBody');
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</td></tr>';
                });
        }
        
        // è®¾ç½®å…¨å±€å‡½æ•°
        window.updatePageData = updatePageData;
        
        // æœç´¢åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#connectionsBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // æ’åºåŠŸèƒ½
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        
        function sortTable(columnIndex, direction) {
            const tbody = document.getElementById('connectionsBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // ç§»é™¤æ‰€æœ‰æ’åºæ ·å¼
            document.querySelectorAll('.connections-table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // æ·»åŠ å½“å‰æ’åºæ ·å¼
            const header = document.querySelectorAll('.connections-table th')[columnIndex];
            header.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // æ’åºå‡½æ•°
            const sortFunction = (a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                
                // å°è¯•è§£æä¸ºæ•°å­—
                const aNum = parseFloat(aText.replace(/[^\d.]/g, ''));
                const bNum = parseFloat(bText.replace(/[^\d.]/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return direction === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // æŒ‰å­—ç¬¦ä¸²æ’åº
                return direction === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
            };
            
            // æ’åºå¹¶é‡æ–°æ’å…¥
            rows.sort(sortFunction);
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // è¡¨å¤´ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.connections-table th').forEach((th, index) => {
            th.addEventListener('click', () => {
                if (currentSortColumn === index) {
                    // åˆ‡æ¢æ’åºæ–¹å‘
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // æ–°åˆ—ï¼Œé»˜è®¤å‡åº
                    currentSortColumn = index;
                    currentSortDirection = 'asc';
                }
                
                sortTable(currentSortColumn, currentSortDirection);
            });
        });
        
        // åœ°ç†ä½ç½®æŸ¥è¯¢åŠŸèƒ½
        function setupLocationLookupButtons() {
            // ä¸ºæ‰€æœ‰åœ°ç†ä½ç½®æŸ¥è¯¢æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.btn-lookup').forEach(button => {
                button.addEventListener('click', function() {
                    const ipAddress = this.getAttribute('data-ip');
                    const locationSpan = this.previousElementSibling;
                    
                    if (!ipAddress || ipAddress === '127.0.0.1' || ipAddress === 'localhost') {
                        alert('æ— æ³•æŸ¥è¯¢æœ¬åœ°åœ°å€çš„åœ°ç†ä½ç½®');
                        return;
                    }
                    
                    // è®¾ç½®åŠ è½½çŠ¶æ€
                    this.disabled = true;
                    this.classList.add('loading');
                    this.textContent = 'â³';
                    
                    // å‘é€æŸ¥è¯¢è¯·æ±‚
                    fetch('/api/lookup_ip', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ ip: ipAddress })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`æŸ¥è¯¢å¤±è´¥: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            // æ›´æ–°æ˜¾ç¤ºçš„åœ°ç†ä½ç½®ä¿¡æ¯
                            locationSpan.textContent = data.summary || 'æŸ¥è¯¢æˆåŠŸ';
                            locationSpan.classList.add('updated');
                            
                            // ç§»é™¤æŸ¥è¯¢æŒ‰é’®
                            this.style.display = 'none';
                            
                            // æ·»åŠ æˆåŠŸåŠ¨ç”»
                            setTimeout(() => {
                                locationSpan.classList.remove('updated');
                            }, 1000);
                        } else {
                            throw new Error(data.message || 'æŸ¥è¯¢å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        console.error('åœ°ç†ä½ç½®æŸ¥è¯¢é”™è¯¯:', error);
                        alert('åœ°ç†ä½ç½®æŸ¥è¯¢å¤±è´¥: ' + error.message);
                        
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        this.disabled = false;
                        this.classList.remove('loading');
                        this.textContent = 'ğŸ”';
                    });
                });
            });
        }
        
        // æ›´æ–°è¿æ¥æ•°æ®çš„å‡½æ•°ï¼Œæ·»åŠ åœ°ç†ä½ç½®æŸ¥è¯¢æŒ‰é’®çš„é‡æ–°ç»‘å®š
        const originalUpdatePageData = window.updatePageData;
        window.updatePageData = function() {
            return originalUpdatePageData().then(() => {
                // æ¯æ¬¡æ•°æ®æ›´æ–°åé‡æ–°ç»‘å®šåœ°ç†ä½ç½®æŸ¥è¯¢æŒ‰é’®
                setTimeout(setupLocationLookupButtons, 0);
            });
        };
        
        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            // æ›´æ–°æ•°æ®
            window.updatePageData();
            
            // åˆå§‹åŒ–åœ°ç†ä½ç½®æŸ¥è¯¢æŒ‰é’®
            setTimeout(setupLocationLookupButtons, 0);
        }
        
        // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®ï¼Œç¡®ä¿å®æ—¶æ€§
        setInterval(window.updatePageData, 1000);
        
        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
        window.addEventListener('resize', function() {
            connectionsChart.resize();
        });
        
        // å¯¼å‡ºCSVåŠŸèƒ½
        document.getElementById('exportCsvBtn').addEventListener('click', function() {
            // è·å–å½“å‰è¡¨æ ¼æ•°æ®
            fetch('/api/sessions')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`è·å–æ•°æ®å¤±è´¥: ${response.status}`);
                    }
                    return response.json();
                })
                .then(connections => {
                    if (!Array.isArray(connections) || connections.length === 0) {
                        alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º');
                        return;
                    }

                    // å®šä¹‰CSVæ ‡é¢˜è¡Œ
                    const csvHeader = [
                        'åè®®', 'æœ¬åœ°åœ°å€', 'è¿œç¨‹åœ°å€', 'åœ°ç†ä½ç½®', 'è¿›ç¨‹å', 
                        'å‘é€å­—èŠ‚', 'æ¥æ”¶å­—èŠ‚', 'æ€»æµé‡', 'çŠ¶æ€', 'æ—¶é•¿(ç§’)'
                    ];

                    // è½¬æ¢æ•°æ®è¡Œ
                    const csvRows = connections.map(conn => {
                        // æ ¼å¼åŒ–å­—èŠ‚å¤§å°
                        function formatBytes(bytes) {
                            if (bytes === 0) return '0 B';
                            const k = 1024;
                            const sizes = ['B', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                        }

                        // æ ¼å¼åŒ–æ—¶é•¿
                        function formatDuration(seconds) {
                            if (seconds < 60) return seconds + 'ç§’';
                            if (seconds < 3600) return Math.floor(seconds / 60) + 'åˆ†';
                            return Math.floor(seconds / 3600) + 'æ—¶' + Math.floor((seconds % 3600) / 60) + 'åˆ†';
                        }

                        return [
                            conn.protocol,
                            `${conn.src_ip}:${conn.src_port}`,
                            `${conn.dst_ip}:${conn.dst_port}`,
                            conn.location || 'æœªçŸ¥',
                            conn.process_name && conn.process_name.toLowerCase() !== 'unknown' ? conn.process_name : (conn.pid ? 'PID:' + conn.pid : 'æœªçŸ¥'),
                            formatBytes(conn.bytes_sent),
                            formatBytes(conn.bytes_received),
                            formatBytes(conn.total_bytes),
                            conn.state,
                            formatDuration(conn.duration)
                        ].map(field => `"${field}"`).join(','); // ç”¨å¼•å·åŒ…å›´æ¯ä¸ªå­—æ®µå¹¶ç”¨é€—å·åˆ†éš”
                    });

                    // ç»„åˆCSVå†…å®¹
                    const csvContent = [csvHeader.join(','), ...csvRows].join('\n');

                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `è¿æ¥çŠ¶æ€_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(error => {
                    console.error('å¯¼å‡ºCSVå¤±è´¥:', error);
                    alert('å¯¼å‡ºCSVå¤±è´¥: ' + error.message);
                });
        });

        // åˆå§‹åŒ–é¡µé¢
        initializePage();
    </script>
</body>
</html>