<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的Windows网络实时连接监控 - 协议分析</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .nav {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .nav a {
            padding: 15px 20px;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .nav a:hover {
            background-color: #3498db;
            color: white;
        }
        
        .nav a.active {
            background-color: #3498db;
            color: white;
        }
        

        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            height: 300px;
        }
        
        .protocols-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .protocols-table th,
        .protocols-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .protocols-table th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        .protocols-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .protocols-table tr:last-child td {
            border-bottom: none;
        }
        
        .search-box {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .search-box input {
            padding: 10px;
            width: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        

    </style>
</head>
<body>
    <div class="container">
        <h1>我的Windows网络实时连接监控 - 协议分析</h1>
        
        <div class="nav">
            <a href="/dashboard">仪表盘</a>
            <a href="/connections">连接监控</a>
            <a href="/processes">进程监控</a>
            <a href="/protocols" class="active">协议分析</a>
            <a href="/earth">地球视图</a>
        </div>
        

        
        <div class="charts-grid">
            <div class="chart-container" id="protocolPieChart"></div>
            <div class="chart-container" id="protocolBarChart"></div>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索协议...">
        </div>
        
        <table class="protocols-table">
            <thead>
                <tr>
                    <th>协议</th>
                    <th>连接数</th>
                    <th>数据包数</th>
                    <th>字节数</th>
                </tr>
            </thead>
            <tbody id="protocolsBody">
                <tr>
                    <td colspan="4" style="text-align: center; color: #666; font-style: italic;">加载中......</td>
                </tr>
            </tbody>
        </table>
    </div>
    


    <script>
        // 初始化ECharts图表
        const protocolPieChart = echarts.init(document.getElementById('protocolPieChart'));
        const protocolBarChart = echarts.init(document.getElementById('protocolBarChart'));
        
        // 协议颜色映射
        const colorMap = {HTTP:'#e74c3c',HTTPS:'#27ae60',DNS:'#3498db',TCP:'#9b59b6',UDP:'#f39c12'};
        
        // 图表选项
        const pieOption = {
            title: {
                text: '协议分布',
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: '{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'vertical',
                left: 'left'
            },
            series: [{
                name: '协议分布',
                type: 'pie',
                radius: '50%',
                data: [],
                itemStyle: {
                    color: function(params) {
                        return colorMap[params.name] || '#2c3e50';
                    }
                },
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        };
        
        const barOption = {
            title: {
                text: '协议连接数',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                top: 60,
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: []
            },
            yAxis: {
                type: 'value',
                name: '连接数'
            },
            series: [{
                name: '连接数',
                type: 'bar',
                barWidth: '60%',
                data: [],
                itemStyle: {
                    color: '#3498db'
                }
            }]
        };
        
        // 设置图表选项
        protocolPieChart.setOption(pieOption);
        protocolBarChart.setOption(barOption);
        
        // 更新协议分析页面
        function updateProtocols() {
            const tbody = document.getElementById('protocolsBody');
            
            // 获取协议数据
            fetch('/api/protocols')
                .then(response => {
                    if (!response.ok) {
                        console.error(`Protocols API error: ${response.status}`);
                        throw new Error(`API error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // 提取实际数据
                    let protocols = data && data.status === 'success' ? data.data : data;
                    
                    // 确保protocols是对象且不为null
                    if (!protocols || typeof protocols !== 'object' || protocols === null || Array.isArray(protocols)) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">暂无协议数据</td></tr>';
                        
                        // 显示示例数据以保持图表可用
                        const exampleProtocols = {
                            'TCP': {session_count: 15, packets: 0, bytes: 0},
                            'UDP': {session_count: 8, packets: 0, bytes: 0},
                            'HTTP': {session_count: 5, packets: 0, bytes: 0}
                        };
                        
                        updateProtocolCharts(exampleProtocols);
                        return;
                    }
                    
                    // 检查是否有数据
                    const protocolKeys = Object.keys(protocols);
                    if (protocolKeys.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">暂无协议数据</td></tr>';
                        
                        // 显示示例数据以保持图表可用
                        const exampleProtocols = {
                            'TCP': {session_count: 15, packets: 0, bytes: 0},
                            'UDP': {session_count: 8, packets: 0, bytes: 0},
                            'HTTP': {session_count: 5, packets: 0, bytes: 0}
                        };
                        
                        updateProtocolCharts(exampleProtocols);
                        return;
                    }
                    
                    // 批量生成HTML
                    let html = '';
                    let chartData = [];
                    let sessionCounts = [];
                    
                    for (const [protocol, data] of Object.entries(protocols)) {
                        html += `
                            <tr>
                                <td>${protocol}</td>
                                <td>${data.session_count || 0}</td>
                                <td>${data.packets || 0}</td>
                                <td>${data.bytes || 0}</td>
                            </tr>
                        `;
                        
                        chartData.push({
                            name: protocol,
                            value: data.session_count || 0
                        });
                        
                        sessionCounts.push(data.session_count || 0);
                    }
                    
                    // 一次性更新DOM
                    tbody.innerHTML = html;
                    
                    // 更新协议图表
                    protocolPieChart.setOption({
                        series: [{ data: chartData }]
                    });
                    
                    protocolBarChart.setOption({
                        xAxis: { data: protocolKeys },
                        series: [{ data: sessionCounts }]
                    });
                })
                .catch(error => {
                    console.error('Protocols API error:', error);
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">加载数据失败，请稍后重试</td></tr>';
                });
        }
        
        // 更新协议图表函数
        function updateProtocolCharts(protocols) {
            const protocolNames = Object.keys(protocols);
            const sessionCounts = Object.values(protocols).map(p => p.session_count || 0);
            
            // 确保有数据才更新图表
            if (protocolNames.length > 0) {
                const pieData = protocolNames.map((name, index) => ({
                    name: name,
                    value: sessionCounts[index]
                }));
                
                protocolPieChart.setOption({
                    series: [{ data: pieData }]
                });
                
                protocolBarChart.setOption({
                    xAxis: { data: protocolNames },
                    series: [{ data: sessionCounts }]
                });
            }
        }
        

        

        
        // 搜索功能
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#protocolsBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // 初始化页面
        updateProtocols();
        
        // 每5秒更新一次数据，减少网络请求
        setInterval(updateProtocols, 5000);
        
        // 窗口大小变化时重新调整图表大小
        window.addEventListener('resize', function() {
            protocolPieChart.resize();
            protocolBarChart.resize();
        });
    </script>
</body>
</html>